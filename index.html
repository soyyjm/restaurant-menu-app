<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¤å…æ¯æ—¥èœå•ç®¡ç†å·¥å…· - äº‘ç«¯ç‰ˆï¼ˆä¿®å¤ç‰ˆï¼‰</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px;
        }
        .sync-status {
            position: fixed; top: 20px; right: 20px;
            background: rgba(255,255,255,0.9); padding: 8px 16px; border-radius: 20px;
            font-size: 12px; font-weight: 500; z-index: 1000; backdrop-filter: blur(10px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .sync-status.synced { color: #28a745; border-left: 3px solid #28a745; }
        .sync-status.syncing { color: #ffc107; border-left: 3px solid #ffc107; }
        .sync-status.error { color: #dc3545; border-left: 3px solid #dc3545; }
        .container { max-width: 1400px; margin: 0 auto; display: grid; grid-template-columns: 1fr 1fr; gap: 30px; height: calc(100vh - 40px); }
        .panel { background: rgba(255,255,255,0.95); border-radius: 20px; padding: 25px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); backdrop-filter: blur(10px); overflow-y: auto; }
        .panel h2 { color: #333; margin-bottom: 20px; font-size: 1.8em; font-weight: 600; }
        .form-group { margin-bottom: 15px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .translate-row { display: grid; grid-template-columns: 1fr auto 1fr; gap: 10px; align-items: end; }
        label { display: block; margin-bottom: 5px; font-weight: 500; color: #555; }
        input, select, textarea { width: 100%; padding: 12px 15px; border: 2px solid #e1e5e9; border-radius: 10px; font-size: 14px; transition: all 0.3s ease; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,0.1); }
        .input-warning { border-color: #ff9800 !important; box-shadow: 0 0 0 3px rgba(255,152,0,0.1) !important; }
        .correction-hint { font-size: 12px; color: #ff9800; margin-top: 5px; padding: 5px 10px; background: rgba(255,152,0,0.1); border-radius: 5px; display: none; }
        .btn { background: linear-gradient(45deg, #667eea, #764ba2); color: white; border: none; padding: 12px 25px; border-radius: 10px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.3s ease; margin-right: 10px; margin-bottom: 10px; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(102,126,234,0.3); }
        .btn-small { padding: 6px 10px; font-size: 12px; margin: 0; }
        .btn-secondary { background: linear-gradient(45deg, #f093fb, #f5576c); }
        .btn-danger { background: linear-gradient(45deg, #ff6b6b, #ee5a24); }
        .btn-translate { background: linear-gradient(45deg, #4ecdc4, #44a08d); padding: 12px 15px; min-width: 80px; }
        .collapsible-section { border: 2px solid #e1e5e9; border-radius: 10px; margin-bottom: 15px; }
        .section-header { background: #f8f9fa; padding: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-radius: 8px; transition: background 0.3s ease; }
        .section-header:hover { background: #e9ecef; }
        .section-header h3 { color: #667eea; font-size: 1.1em; font-weight: 600; }
        .section-content { overflow: hidden; transition: all 0.3s ease; }
        .section-content:not(.expanded) { max-height: 0; padding: 0; }
        .section-content.expanded { max-height: none; padding: 15px; }
        .dish-item { background: #f8f9fa; padding: 15px; margin-bottom: 10px; border-radius: 10px; border-left: 4px solid #667eea; position: relative; }
        .dish-item.selected { background: #e8f4fd; border-left-color: #f5576c; }
        .dish-item h4 { color: #333; margin-bottom: 5px; }
        .dish-item p { color: #666; font-size: 13px; margin-bottom: 3px; }
        .dish-actions { position: absolute; top: 10px; right: 10px; }
        .dish-actions button { padding: 5px 10px; font-size: 12px; margin-left: 5px; }
        .dessert-checkboxes { padding: 15px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .dessert-row { display: grid; grid-template-columns: auto 1fr auto; align-items: center; gap: 8px; background: #f8f9fa; padding: 8px; border-radius: 6px; }
        .dessert-row label { font-size: 12px; line-height: 1.2; margin: 0; }
        .price-info { font-size: 12px; color: #666; margin-top: 5px; }
        .manual-add { background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px; }
        .manual-add h4 { color: #667eea; margin-bottom: 10px; }
        .menu-preview { background: white; padding: 25px; margin-top: 20px; border-radius: 10px; font-family: Arial, sans-serif; box-shadow: 0 10px 30px rgba(0,0,0,0.1); font-size: 13px; line-height: 1.4; }
        .menu-header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 15px; margin-bottom: 20px; }
        .menu-title { font-size: 2em; font-style: italic; margin-bottom: 8px; color: #333; }
        .menu-date-price { display: flex; justify-content: space-between; font-size: 1em; font-weight: bold; }
        .menu-section { margin-bottom: 20px; }
        .section-title { font-size: 1.1em; font-weight: bold; margin-bottom: 10px; color: #333; text-transform: uppercase; }
        .menu-item { margin-bottom: 12px; padding-bottom: 8px; }
        .menu-item-spanish { font-weight: 500; color: #333; margin-bottom: 2px; font-size: 13px; }
        .menu-item-catalan { font-style: italic; color: #666; font-size: 11px; }
        .menu-item-extra { color: #888; font-size: 11px; }
        .menu-hours { text-align: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid #ddd; font-size: 1em; font-weight: bold; }
        .selected-dishes { background: #e8f4fd; padding: 15px; border-radius: 10px; margin-bottom: 20px; }
        .selected-dishes h3 { margin-bottom: 10px; color: #333; }
        .selected-dish { display: flex; justify-content: space-between; align-items: center; padding: 12px 8px; margin-bottom: 8px; background: white; border-radius: 8px; border-left: 4px solid #667eea; cursor: grab; transition: all 0.3s ease; position: relative; }
        .selected-dish:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.1); transform: translateY(-1px); }
        .selected-dish.dragging { opacity: 0.5; transform: rotate(5deg); cursor: grabbing; }
        .selected-dish .dish-content { flex: 1; margin-right: 10px; }
        .selected-dish .dish-actions { display: flex; gap: 5px; }
        .selected-dish .drag-handle { position: absolute; left: 8px; top: 50%; transform: translateY(-50%); color: #ccc; font-size: 14px; cursor: grab; }
        .selected-dish .drag-handle:hover { color: #667eea; }
        .edit-mode { background: #fff3cd !important; border-left-color: #ffc107 !important; }
        .edit-inputs { display: flex; flex-direction: column; gap: 8px; flex: 1; margin-right: 10px; }
        .edit-inputs input { padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; }
        .edit-inputs input:focus { outline: none; border-color: #667eea; }
        .category-section { margin-bottom: 20px; border-radius: 8px; overflow: hidden; }
        .category-header { background: linear-gradient(45deg, #667eea, #764ba2); color: white; padding: 8px 12px; font-weight: bold; font-size: 14px; }
        .category-dishes { min-height: 50px; padding: 10px; }
        .drop-zone { border: 2px dashed #667eea; background: rgba(102,126,234,0.05); border-radius: 8px; padding: 20px; text-align: center; color: #667eea; }
        .rotate-icon { transition: transform 0.3s ease; }
        .rotate-icon.rotated { transform: rotate(90deg); }
        .menu-controls { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e1e5e9; }
        .loading { opacity: 0.5; pointer-events: none; }
        .help { font-size: 12px; color:#666; }
    </style>
</head>
<body>
    <div id="syncStatus" class="sync-status synced">â˜ï¸ å·²åŒæ­¥</div>

    <div class="container">
        <div class="panel">
            <h2>ğŸ½ï¸ èœå“æ•°æ®åº“ç®¡ç†</h2>
            <div class="form-group">
                <div class="translate-row">
                    <div>
                        <label>è¥¿ç­ç‰™è¯­èœå</label>
                        <input type="text" id="dishSpanish" placeholder="ä¾‹: Paella del seÃ±orito" oninput="checkSpelling(this)">
                        <div class="correction-hint" id="spanishHint"></div>
                    </div>
                    <div style="align-self: end;">
                        <button class="btn btn-translate" onclick="autoTranslate()">ğŸ”„ ç¿»è¯‘</button>
                    </div>
                    <div>
                        <label>åŠ æ³°ç½—å°¼äºšè¯­ç¿»è¯‘</label>
                        <input type="text" id="dishCatalan" placeholder="ä¾‹: Paella del senyoret">
                    </div>
                </div>
            </div>

            <div class="form-group">
                <div class="form-row">
                    <div>
                        <label>åˆ†ç±»</label>
                        <select id="dishCategory">
                            <option value="primer">PRIMER PLATO</option>
                            <option value="segundo">SEGUNDO PLATO</option>
                            <option value="postre">POSTRES</option>
                        </select>
                    </div>
                    <div>
                        <label>é¢å¤–è´¹ç”¨</label>
                        <input type="text" id="dishExtra" placeholder="ä¾‹: +3.00â‚¬">
                    </div>
                </div>
            </div>

            <button class="btn" onclick="addDish()">â• æ·»åŠ èœå“</button>
            <button class="btn btn-secondary" onclick="exportData()">ğŸ“¥ å¯¼å‡ºæ•°æ®</button>
            <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">ğŸ“¤ å¯¼å…¥æ•°æ®</button>
            <button class="btn btn-secondary" onclick="dedupeDishes()">ğŸ§¹ æ¸…ç†é‡å¤</button>
            <input type="file" id="importFile" style="display:none" accept=".json" onchange="importData(event)">
            <div class="help">æç¤ºï¼šç°åœ¨ POSTRES é¡¹ä¹Ÿå¯åˆ é™¤ï¼›æ¸…ç†é‡å¤ä¼šæŒ‰â€œåŒåˆ†ç±» + ç›¸åŒè¥¿è¯­åï¼ˆå¿½ç•¥å¤§å°å†™ä¸å¤šç©ºæ ¼ï¼‰â€åˆå¹¶ã€‚</div>

            <div id="dishesContainer"></div>
        </div>

        <div class="panel">
            <div class="menu-controls">
                <h2>ğŸ“‹ æ¯æ—¥èœå•ç”Ÿæˆ</h2>
                <div class="form-group">
                    <div class="form-row">
                        <div>
                            <label>èœå•ä»·æ ¼</label>
                            <input type="text" id="menuPrice" value="13.50 â‚¬">
                            <div class="price-info" id="priceInfo">ä»Šå¤©æ˜¯å·¥ä½œæ—¥ï¼Œå»ºè®®ä»·æ ¼ï¼š13.50 â‚¬</div>
                        </div>
                        <div>
                            <label>æ—¥æœŸ</label>
                            <input type="date" id="menuDate">
                        </div>
                    </div>
                </div>

                <div class="manual-add">
                    <h4>ğŸ–Šï¸ æ‰‹åŠ¨æ·»åŠ èœå“</h4>
                    <div class="translate-row">
                        <div>
                            <input type="text" id="manualSpanish" placeholder="è¥¿ç­ç‰™è¯­èœå" oninput="checkSpelling(this)">
                            <div class="correction-hint" id="manualSpanishHint"></div>
                        </div>
                        <div style="align-self: center;">
                            <button class="btn btn-translate btn-small" onclick="translateManual()">ğŸ”„</button>
                        </div>
                        <div>
                            <input type="text" id="manualCatalan" placeholder="åŠ æ³°ç½—å°¼äºšè¯­ç¿»è¯‘">
                        </div>
                    </div>
                    <div class="form-row" style="margin-top: 10px;">
                        <select id="manualCategory">
                            <option value="primer">PRIMER PLATO</option>
                            <option value="segundo">SEGUNDO PLATO</option>
                            <option value="postre">POSTRES</option>
                        </select>
                        <button class="btn btn-small" onclick="addManualDish()">æ·»åŠ åˆ°èœå•</button>
                    </div>
                </div>

                <div class="selected-dishes">
                    <h3>ä»Šæ—¥èœå•</h3>
                    <div id="selectedDishes">
                        <p style="color: #888; text-align: center; padding: 20px;">è¯·ä»å·¦ä¾§èœå“åº“ä¸­é€‰æ‹©èœå“æˆ–æ‰‹åŠ¨æ·»åŠ </p>
                    </div>
                </div>

                <button class="btn" onclick="generateMenu()">ğŸ´ ç”Ÿæˆèœå•</button>
                <button class="btn btn-secondary" onclick="printMenu()">ğŸ–¨ï¸ æ‰“å°èœå•</button>
                <button class="btn btn-danger" onclick="clearSelectedDishes()">ğŸ—‘ï¸ æ¸…ç©ºé€‰æ‹©</button>
            </div>

            <div class="menu-preview" id="menuPreview" style="display: none;"></div>
        </div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        // ---- äº‘ç«¯é…ç½®ï¼ˆæ¼”ç¤ºï¼‰ ----
        const SUPABASE_URL = 'https://nkteqmgslcrqiglzcsyv.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5rdGVxbWdzbGNycWlnbHpjc3l2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwMzE4NzMsImV4cCI6MjA3MTYwNzg3M30.XmyXU4LAUYorfwsXjEEjHQsOHDWGa3gESxu2xq3XPm0';
        let supabase, isCloudMode = false;
        try { supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY); isCloudMode = true; updateSyncStatus('synced','â˜ï¸ äº‘ç«¯æ¨¡å¼'); }
        catch(e){ console.log('äº‘ç«¯æ¨¡å¼ä¸å¯ç”¨'); updateSyncStatus('error','ğŸ’¾ æœ¬åœ°æ¨¡å¼'); }

        // ---- çŠ¶æ€ ----
        let dishes = [];
        let selectedDishes = { primer: [], segundo: [], postre: [] };
        let collapseState = JSON.parse(localStorage.getItem('collapseState') || '{"primer":true,"segundo":true,"postre":true}');

        function saveCollapseState(){ localStorage.setItem('collapseState', JSON.stringify(collapseState)); }

        // ---- èŠ‚å‡æ—¥ & æ‹¼å†™è¯å…¸ ----
        const spanishHolidays = ['2025-01-01','2025-01-06','2025-04-18','2025-04-21','2025-05-01','2025-08-15','2025-10-12','2025-11-01','2025-12-06','2025-12-08','2025-12-25'];

        const translations = {
            'pollo':'pollastre','jamÃ³n':'pernil','queso':'formatge','patatas':'patates','huevo':'ou','carne':'carn','pescado':'peix','verduras':'verdures','arroz':'arrÃ²s','pasta':'pasta','ensalada':'amanida','sopa':'sopa','crema':'crema','flan':'flan','helado':'gelat','fruta':'fruita','chocolate':'xocolata','con':'amb','del':'del','de':'de','al':'al','horno':'forn','plancha':'planxa','frito':'fregit','asado':'rostit','ternera':'vedella','cerdo':'porc','setas':'bolets','seta':'bolet','gambas':'gambes','calamar':'calamar','calamares':'calamars','lechuga':'enciam','tomate':'tomÃ quet','pimiento':'pebrot','cebolla':'ceba'
        };
        const phraseGlossary = [
            [/a la plancha/gi, 'a la planxa'],
            [/al horno/gi, 'al forn'],
            [/frito(s)?/gi, 'fregit$1'],
            [/rebozado/gi, 'arrebossat'],
            [/del d[iÃ­]a/gi, 'del dia'],
            [/ensalada/gi, 'amanida'],
            [/sopa del d[iÃ­]a/gi, 'sopa del dia'],
            [/crema del d[iÃ­]a/gi, 'crema del dia'],
            [/tarta de queso/gi, 'pastÃ­s de formatge'],
            [/solomillo/gi, 'filet'],
            [/salmorejo/gi, 'salmorejo'],
            [/paella del se[nÃ±]orito/gi, 'paella del senyoret']
        ];

        const spellCheck = {'polla':'pollo','jamon':'jamÃ³n','patata':'patatas','huevos':'huevo','verdura':'verduras','pescao':'pescado','tomate':'tomates','cebolla':'cebollas','ajo':'ajos','pimiento':'pimientos','calabacin':'calabacÃ­n','berenjena':'berenjenas','champiÃ±on':'champiÃ±ones','limon':'limÃ³n','melon':'melÃ³n','oregano':'orÃ©gano','senor':'seÃ±or','nina':'niÃ±a','nino':'niÃ±o','anos':'aÃ±os','manana':'maÃ±ana','espanol':'espaÃ±ol','corazon':'corazÃ³n'};

        function updateSyncStatus(status, message){
            const el = document.getElementById('syncStatus');
            el.className = `sync-status ${status}`; el.textContent = message;
        }

        async function loadCloudData(){
            if(!isCloudMode){ return loadLocalData(); }
            try{
                updateSyncStatus('syncing','ğŸ”„ åŒæ­¥ä¸­...');
                const { data: dishesData, error: dishesError } = await supabase.from('dishes').select('*').order('created_at',{ascending:true});
                if(dishesError) throw dishesError;
                const { data: menuData, error: menuError } = await supabase.from('selected_menu').select('*').single();
                if(!menuError && menuData){ selectedDishes = menuData.dishes; }
                dishes = dishesData || [];
                updateSyncStatus('synced','â˜ï¸ å·²åŒæ­¥');
            }catch(e){
                console.error(e); updateSyncStatus('error','âš ï¸ åŒæ­¥å¤±è´¥'); loadLocalData();
            }
        }
        async function saveCloudData(){
            if(!isCloudMode){ return saveLocalData(); }
            try{
                updateSyncStatus('syncing','ğŸ”„ ä¿å­˜ä¸­...');
                const { error: dishesError } = await supabase.from('dishes').upsert(dishes.map(d=>({...d, created_at: d.created_at || new Date().toISOString(), updated_at: new Date().toISOString()})));
                if(dishesError) throw dishesError;
                const { error: menuError } = await supabase.from('selected_menu').upsert({ id:1, dishes:selectedDishes, updated_at:new Date().toISOString() });
                if(menuError) throw menuError;
                updateSyncStatus('synced','â˜ï¸ å·²åŒæ­¥');
            }catch(e){ console.error(e); updateSyncStatus('error','âš ï¸ ä¿å­˜å¤±è´¥'); saveLocalData(); }
        }
        function loadLocalData(){
            dishes = JSON.parse(localStorage.getItem('restaurantDishes') || '[]');
            selectedDishes = JSON.parse(localStorage.getItem('selectedDishes') || '{"primer":[],"segundo":[],"postre":[]}');
        }
        function saveLocalData(){
            localStorage.setItem('restaurantDishes', JSON.stringify(dishes));
            localStorage.setItem('selectedDishes', JSON.stringify(selectedDishes));
        }

        document.addEventListener('DOMContentLoaded', async function(){
            const today = new Date();
            document.getElementById('menuDate').value = today.toISOString().split('T')[0];
            await loadInitialDishes();
            await loadCloudData();
            updatePricing();
            renderDishesContainer();
            renderSelectedDishes();
            document.getElementById('menuDate').addEventListener('change', updatePricing);
        });

        async function loadInitialDishes(){
            const initialDishes = [
                { id: Date.now()+1, spanish:"Ensalada con crujiente de pollo, piÃ±a, frutos secos y vinagreta de miel y mostaza", catalan:"Amanida amb cruixent de pollastre, pinya, fruita seca i vinagreta de mel i mostassa", category:"primer", extra:"" },
                { id: Date.now()+2, spanish:"Salmorejo cordobÃ©s con huevo rallado y virutas de jamÃ³n", catalan:"Salmorejo cordovÃ¨s amb ou ratllat i encenalls de pernil", category:"primer", extra:"" },
                { id: Date.now()+3, spanish:"Paella del seÃ±orito", catalan:"Paella del senyoret", category:"segundo", extra:"" },
                { id: Date.now()+4, spanish:"Dorada al horno con patatas panadera", catalan:"Daurada al forn amb patates fornera", category:"segundo", extra:"" },
                { id: Date.now()+5, spanish:"Tarta de queso", catalan:"PastÃ­s de formatge", category:"postre", extra:"" },
                { id: Date.now()+6, spanish:"Flan", catalan:"Flam", category:"postre", extra:"" },
                { id: Date.now()+7, spanish:"Coulant de chocolate", catalan:"Coulant de xocolata", category:"postre", extra:"+ 2.00â‚¬" }
            ];
            if(dishes.length===0){ dishes = initialDishes; await saveCloudData(); }
        }

        function checkSpelling(input){
            const text = input.value.toLowerCase().trim();
            const hintId = input.id === 'dishSpanish' ? 'spanishHint' : 'manualSpanishHint';
            const hint = document.getElementById(hintId);
            if(!text){ hint.style.display='none'; input.classList.remove('input-warning'); return; }
            const words = text.split(/\\s+/); const corrections = [];
            words.forEach(w=>{ if(spellCheck[w]) corrections.push(`"${w}" â†’ "${spellCheck[w]}"`); });
            if(corrections.length>0){ input.classList.add('input-warning'); hint.innerHTML = `å»ºè®®ä¿®æ­£: ${corrections.join(', ')}`; hint.style.display='block'; }
            else { input.classList.remove('input-warning'); hint.style.display='none'; }
        }

        function updatePricing(){
            const dateInput = document.getElementById('menuDate');
            const priceInput = document.getElementById('menuPrice');
            const priceInfo = document.getElementById('priceInfo');
            const selectedDate = new Date(dateInput.value);
            const dayOfWeek = selectedDate.getDay(); const dateString = dateInput.value;
            const isWeekend = dayOfWeek===0 || dayOfWeek===6; const isHoliday = spanishHolidays.includes(dateString);
            if(isWeekend || isHoliday){ priceInput.value='18.50 â‚¬'; priceInfo.textContent = isHoliday ? 'ä»Šå¤©æ˜¯è¥¿ç­ç‰™æ³•å®šå‡æ—¥ï¼Œå»ºè®®ä»·æ ¼ï¼š18.50 â‚¬' : 'ä»Šå¤©æ˜¯å‘¨æœ«ï¼Œå»ºè®®ä»·æ ¼ï¼š18.50 â‚¬'; }
            else { priceInput.value='13.50 â‚¬'; priceInfo.textContent='ä»Šå¤©æ˜¯å·¥ä½œæ—¥ï¼Œå»ºè®®ä»·æ ¼ï¼š13.50 â‚¬'; }
        }

        // ---- ç¿»è¯‘ï¼šåœ¨çº¿ + æœ¯è¯­è¡¨åå¤„ç† ----
        function postProcessCatalan(text){
            if(!text) return text;
            let s = text;
            // çŸ­è¯­ä¼˜å…ˆ
            phraseGlossary.forEach(([re, ca])=>{ s = s.replace(re, ca); });
            // è¯çº§åˆ«å…œåº•
            s = s.split(/(\\W)/).map(tok => (translations[tok.toLowerCase()] || tok)).join('');
            // å¸¸è§ä¿®æ­£
            s = s.replace(/\\s+/g,' ').replace(/\\s,\\s/g, ', ').replace(/\\s\\./g,'.').trim();
            // é¦–å­—æ¯ä¸è¦å…¨å¤§å†™ â€”â€” ä¿ç•™åŸæ ·
            return s;
        }

        async function translateText(text){
            if(!text.trim()) return text;
            try{
                updateSyncStatus('syncing','ğŸ”„ ç¿»è¯‘ä¸­...');
                const response = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=es|ca`);
                const data = await response.json();
                updateSyncStatus('synced','â˜ï¸ å·²åŒæ­¥');
                if(data.responseStatus===200){ return postProcessCatalan(data.responseData.translatedText); }
                return postProcessCatalan(simpleTranslate(text));
            }catch(e){
                console.error('åœ¨çº¿ç¿»è¯‘å¤±è´¥:', e);
                updateSyncStatus('synced','â˜ï¸ å·²åŒæ­¥');
                return postProcessCatalan(simpleTranslate(text));
            }
        }
        function simpleTranslate(text){
            // ç®€æ˜“é€è¯ï¼ˆä»…å…œåº•ï¼‰
            return text.split(/(\\W)/).map(tok => translations[tok.toLowerCase()] || tok).join('');
        }
        async function autoTranslate(){
            const spanish = document.getElementById('dishSpanish').value.trim(); if(!spanish) return;
            const catalan = await translateText(spanish); document.getElementById('dishCatalan').value = catalan;
        }
        async function translateManual(){
            const spanish = document.getElementById('manualSpanish').value.trim(); if(!spanish) return;
            const catalan = await translateText(spanish); document.getElementById('manualCatalan').value = catalan;
        }

        // ---- å·¥å…· ----
        const normalize = s => s.trim().toLowerCase().replace(/\\s+/g,' ');

        function existsDuplicate(spanish, category){
            const key = normalize(spanish);
            return dishes.some(d => d.category===category && normalize(d.spanish)===key);
        }

        // ---- æ·»åŠ ã€åˆ é™¤ã€æŠ˜å  ----
        async function addDish(){
            const spanish = document.getElementById('dishSpanish').value.trim();
            const catalan = document.getElementById('dishCatalan').value.trim();
            const category = document.getElementById('dishCategory').value;
            const extra = document.getElementById('dishExtra').value.trim();
            if(!spanish || !catalan){ alert('è¯·å¡«å†™èœå“çš„è¥¿ç­ç‰™è¯­å’ŒåŠ æ³°ç½—å°¼äºšè¯­åç§°'); return; }
            if(existsDuplicate(spanish, category)){ alert('è¯¥åˆ†ç±»ä¸‹å·²å­˜åœ¨ç›¸åŒèœåï¼ˆè¥¿è¯­ï¼‰ã€‚'); return; }
            const dish = { id: Date.now(), spanish, catalan, category, extra };
            dishes.push(dish);
            await saveCloudData();
            renderDishesContainer(); // å°†ä¿ç•™æŠ˜å çŠ¶æ€
            // reset
            document.getElementById('dishSpanish').value=''; document.getElementById('dishCatalan').value=''; document.getElementById('dishExtra').value='';
            document.getElementById('spanishHint').style.display='none'; document.getElementById('dishSpanish').classList.remove('input-warning');
        }

        async function addManualDish(){
            const spanish = document.getElementById('manualSpanish').value.trim();
            const catalan = document.getElementById('manualCatalan').value.trim();
            const category = document.getElementById('manualCategory').value;
            if(!spanish || !catalan){ alert('è¯·å¡«å†™èœå“çš„è¥¿ç­ç‰™è¯­å’ŒåŠ æ³°ç½—å°¼äºšè¯­åç§°'); return; }
            const dish = { id: Date.now(), spanish, catalan, category, extra:'', temporary:true };
            selectedDishes[category].push(dish);
            await saveCloudData();
            renderSelectedDishes();
            document.getElementById('manualSpanish').value=''; document.getElementById('manualCatalan').value='';
            document.getElementById('manualSpanishHint').style.display='none'; document.getElementById('manualSpanish').classList.remove('input-warning');
        }

        function toggleSection(category){
            const content = document.getElementById(`content-${category}`);
            const icon = document.getElementById(`icon-${category}`);
            const isExp = content.classList.toggle('expanded');
            if(icon) icon.classList.toggle('rotated', isExp);
            collapseState[category] = isExp; saveCollapseState();
        }

        async function toggleDessertCheckbox(dishId){
            const dish = dishes.find(d=>d.id===dishId); if(!dish) return;
            const list = selectedDishes.postre;
            const idx = list.findIndex(d=>d.id===dishId);
            if(idx>=0){ list.splice(idx,1); } else { list.push(dish); }
            await saveCloudData();
            renderSelectedDishes();
            updateDessertCheckboxes();
        }
        function updateDessertCheckboxes(){
            const cbs = document.querySelectorAll('.dessert-checkboxes input[type="checkbox"]');
            cbs.forEach(cb=>{
                const id = parseInt(cb.dataset.dishId);
                cb.checked = selectedDishes.postre.some(d=>d.id===id);
            });
        }

        function renderDishesContainer(){
            const container = document.getElementById('dishesContainer');
            const categories = { primer:'PRIMER PLATO', segundo:'SEGUNDO PLATO', postre:'POSTRES' };
            let html='';
            Object.keys(categories).forEach(category=>{
                const categoryDishes = dishes.filter(d=>d.category===category);
                const expanded = collapseState[category]===undefined ? true : !!collapseState[category];
                html += `
                <div class="collapsible-section">
                    <div class="section-header" onclick="toggleSection('${category}')">
                        <h3>${categories[category]} (${categoryDishes.length})</h3>
                        <span class="rotate-icon ${expanded?'rotated':''}" id="icon-${category}">â–¶</span>
                    </div>
                    <div class="section-content ${expanded?'expanded':''}" id="content-${category}">`;

                if(category==='postre'){
                    html += '<div class="dessert-checkboxes">';
                    categoryDishes.forEach(dish=>{
                        const isSelected = selectedDishes[category].some(d=>d.id===dish.id);
                        html += `
                        <div class="dessert-row" onclick="toggleDessertCheckbox(${dish.id})">
                            <input type="checkbox" ${isSelected?'checked':''} data-dish-id="${dish.id}" onchange="toggleDessertCheckbox(${dish.id}); event.stopPropagation();">
                            <label><strong>${dish.spanish}</strong><br><em>${dish.catalan}</em>${dish.extra?`<br><span style='color:#888;'>${dish.extra}</span>`:''}</label>
                            <button class="btn btn-danger btn-small" title="åˆ é™¤è¯¥ç”œç‚¹" onclick="deleteDish(${dish.id}); event.stopPropagation();">åˆ é™¤</button>
                        </div>`;
                    });
                    html += '</div>';
                }else{
                    categoryDishes.forEach(dish=>{
                        const isSelected = selectedDishes[category].some(d=>d.id===dish.id);
                        html += `
                        <div class="dish-item ${isSelected?'selected':''}" data-dish-id="${dish.id}">
                            <h4>${dish.spanish}</h4>
                            <p><em>${dish.catalan}</em></p>
                            ${dish.extra?`<p class="menu-item-extra">${dish.extra}</p>`:''}
                            <div class="dish-actions">
                                <button class="btn ${isSelected?'btn-danger':'btn-secondary'}" onclick="toggleDish(${dish.id})">${isSelected?'ç§»é™¤':'é€‰æ‹©'}</button>
                                <button class="btn btn-danger" onclick="deleteDish(${dish.id})">åˆ é™¤</button>
                            </div>
                        </div>`;
                    });
                }
                html += '</div></div>';
            });
            container.innerHTML = html;
            updateDessertCheckboxes();
        }

        async function deleteDish(id){
            if(!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªèœå“å—ï¼Ÿ')) return;
            // ä»èœå“åº“åˆ é™¤
            dishes = dishes.filter(d=>d.id!==id);
            // åŒæ­¥ä»å·²é€‰èœå•ä¸­ç§»é™¤
            ['primer','segundo','postre'].forEach(cat => {
                selectedDishes[cat] = selectedDishes[cat].filter(d=>d.id!==id);
            });
            await saveCloudData();
            renderDishesContainer();
            renderSelectedDishes();
        }

        async function toggleDish(id){
            const dish = dishes.find(d=>d.id===id); if(!dish) return;
            const list = selectedDishes[dish.category];
            const idx = list.findIndex(d=>d.id===id);
            if(idx>=0){ list.splice(idx,1); } else { list.push(dish); }
            await saveCloudData();
            updateDishItemStatus(id);
            renderSelectedDishes();
        }

        function updateDishItemStatus(dishId){
            const dish = dishes.find(d=>d.id===dishId); if(!dish) return;
            const el = document.querySelector(`[data-dish-id="${dishId}"]`);
            if(el){
                const isSelected = selectedDishes[dish.category].some(d=>d.id===dishId);
                const dishItem = el.closest('.dish-item');
                if(dishItem){
                    const buttons = el.querySelectorAll('button'); const selectButton = buttons[0];
                    if(isSelected){ dishItem.classList.add('selected'); selectButton.textContent='ç§»é™¤'; selectButton.className='btn btn-danger'; }
                    else { dishItem.classList.remove('selected'); selectButton.textContent='é€‰æ‹©'; selectButton.className='btn btn-secondary'; }
                }
            }
        }

        function editDish(dishId, category){
            const dish = selectedDishes[category].find(d=>d.id===dishId); if(!dish) return;
            const el = document.querySelector(`[data-selected-dish-id="${dishId}"]`); if(!el) return;
            el.classList.add('edit-mode');
            const contentDiv = el.querySelector('.dish-content');
            contentDiv.innerHTML = `
                <div class="edit-inputs">
                    <input type="text" id="edit-spanish-${dishId}" value="${dish.spanish}" placeholder="è¥¿ç­ç‰™è¯­èœå">
                    <input type="text" id="edit-catalan-${dishId}" value="${dish.catalan}" placeholder="åŠ æ³°ç½—å°¼äºšè¯­ç¿»è¯‘">
                    <input type="text" id="edit-extra-${dishId}" value="${dish.extra||''}" placeholder="é¢å¤–è´¹ç”¨">
                </div>`;
            const actionsDiv = el.querySelector('.dish-actions');
            actionsDiv.innerHTML = `
                <button class="btn btn-secondary" style="padding: 3px 8px; font-size: 11px;" onclick="saveEdit(${dishId}, '${category}')">ä¿å­˜</button>
                <button class="btn btn-danger" style="padding: 3px 8px; font-size: 11px;" onclick="cancelEdit(${dishId}, '${category}')">å–æ¶ˆ</button>`;
        }
        async function saveEdit(dishId, category){
            const spanish = document.getElementById(`edit-spanish-${dishId}`).value.trim();
            const catalan = document.getElementById(`edit-catalan-${dishId}`).value.trim();
            const extra = document.getElementById(`edit-extra-${dishId}`).value.trim();
            if(!spanish || !catalan){ alert('è¯·å¡«å†™èœå“çš„è¥¿ç­ç‰™è¯­å’ŒåŠ æ³°ç½—å°¼äºšè¯­åç§°'); return; }
            const dish = selectedDishes[category].find(d=>d.id===dishId);
            dish.spanish = spanish; dish.catalan = catalan; dish.extra = extra;
            await saveCloudData(); renderSelectedDishes();
        }
        function cancelEdit(){ renderSelectedDishes(); }

        // ---- æ‹–æ‹½æ’åº ----
        let draggedElement=null, draggedDishId=null, draggedCategory=null;
        function startDrag(e, dishId, category){ draggedElement = e.target.closest('.selected-dish'); draggedDishId = dishId; draggedCategory = category; draggedElement.classList.add('dragging'); e.dataTransfer.effectAllowed='move'; }
        function allowDrop(e){ e.preventDefault(); e.dataTransfer.dropEffect='move'; }
        async function drop(e, targetCategory){
            e.preventDefault();
            if(!draggedDishId) return;
            const targetElement = e.target.closest('.selected-dish');
            if(targetElement && targetElement!==draggedElement){
                const targetDishId = parseInt(targetElement.dataset.selectedDishId);
                const dish = selectedDishes[draggedCategory].find(d=>d.id===draggedDishId);
                selectedDishes[draggedCategory] = selectedDishes[draggedCategory].filter(d=>d.id!==draggedDishId);
                const targetIndex = selectedDishes[targetCategory].findIndex(d=>d.id===targetDishId);
                selectedDishes[targetCategory].splice(targetIndex, 0, dish);
            }else if(targetCategory !== draggedCategory){
                const dish = selectedDishes[draggedCategory].find(d=>d.id===draggedDishId);
                selectedDishes[draggedCategory] = selectedDishes[draggedCategory].filter(d=>d.id!==draggedDishId);
                selectedDishes[targetCategory].push(dish);
            }
            await saveCloudData();
            renderSelectedDishes(); endDrag();
        }
        function endDrag(){ if(draggedElement){ draggedElement.classList.remove('dragging'); } draggedElement=null; draggedDishId=null; draggedCategory=null; }

        function renderSelectedDishes(){
            const container = document.getElementById('selectedDishes');
            const categories = { primer:'PRIMER PLATO', segundo:'SEGUNDO PLATO', postre:'POSTRES' };
            let html=''; let hasSelected=false;
            Object.keys(categories).forEach(category=>{
                if(selectedDishes[category].length>0){
                    hasSelected=true;
                    html += `<div class="category-section">
                        <div class="category-header">${categories[category]}</div>
                        <div class="category-dishes" ondrop="drop(event, '${category}')" ondragover="allowDrop(event)">`;
                    selectedDishes[category].forEach(dish=>{
                        html += `<div class="selected-dish" draggable="true" data-selected-dish-id="${dish.id}" ondragstart="startDrag(event, ${dish.id}, '${category}')" ondragend="endDrag()">
                            <div class="drag-handle">â‹®â‹®</div>
                            <div class="dish-content">
                                <strong>${dish.spanish}</strong><br>
                                <em style="font-size: 12px; color: #666;">${dish.catalan}</em>
                                ${dish.extra?`<br><span style="font-size: 12px; color: #888;">${dish.extra}</span>`:''}
                                ${dish.temporary?'<br><span style="font-size: 11px; color: #f5576c;">âœ¨ æ‰‹åŠ¨æ·»åŠ </span>':''}
                            </div>
                            <div class="dish-actions">
                                <button class="btn btn-secondary" style="padding: 3px 8px; font-size: 11px;" onclick="editDish(${dish.id}, '${category}')">ç¼–è¾‘</button>
                                <button class="btn btn-danger" style="padding: 3px 8px; font-size: 11px;" onclick="removeDishFromMenu(${dish.id}, '${category}')">ç§»é™¤</button>
                            </div>
                        </div>`;
                    });
                    html += `</div></div>`;
                }else{
                    html += `<div class="category-section"><div class="category-header">${categories[category]}</div>
                    <div class="category-dishes" ondrop="drop(event, '${category}')" ondragover="allowDrop(event)">
                        <div class="drop-zone">æ‹–æ‹½èœå“åˆ°æ­¤å¤„æˆ–ä»å·¦ä¾§é€‰æ‹©</div></div></div>`;
                }
            });
            container.innerHTML = hasSelected ? html :
            `<div class="category-section"><div class="category-header">PRIMER PLATO</div><div class="category-dishes" ondrop="drop(event, 'primer')" ondragover="allowDrop(event)"><div class="drop-zone">æ‹–æ‹½èœå“åˆ°æ­¤å¤„æˆ–ä»å·¦ä¾§é€‰æ‹©</div></div></div>
             <div class="category-section"><div class="category-header">SEGUNDO PLATO</div><div class="category-dishes" ondrop="drop(event, 'segundo')" ondragover="allowDrop(event)"><div class="drop-zone">æ‹–æ‹½èœå“åˆ°æ­¤å¤„æˆ–ä»å·¦ä¾§é€‰æ‹©</div></div></div>
             <div class="category-section"><div class="category-header">POSTRES</div><div class="category-dishes" ondrop="drop(event, 'postre')" ondragover="allowDrop(event)"><div class="drop-zone">æ‹–æ‹½èœå“åˆ°æ­¤å¤„æˆ–ä»å·¦ä¾§é€‰æ‹©</div></div></div>`;
        }

        async function removeDishFromMenu(id, category){
            selectedDishes[category] = selectedDishes[category].filter(d=>d.id!==id);
            await saveCloudData();
            renderDishesContainer();
            renderSelectedDishes();
        }

        function generateMenu(){
            const price = document.getElementById('menuPrice').value;
            const date = new Date(document.getElementById('menuDate').value).toLocaleDateString('es-ES',{ day:'numeric', month:'long' });
            const categories = { primer:'PRIMER PLATO', segundo:'SEGUNDO PLATO', postre:'POSTRES' };
            let menuHtml = `<div class="menu-header">
                    <div class="menu-title">MenÃº del dÃ­a</div>
                    <div style="font-style: italic; color: #666; margin-bottom: 15px;">Restaurante sol</div>
                    <div class="menu-date-price"><span>${price}</span><span>${date}</span></div>
                </div>`;
            Object.keys(categories).forEach(category=>{
                if(selectedDishes[category].length>0){
                    menuHtml += `<div class="menu-section"><div class="section-title">${categories[category]}</div>`;
                    if(category==='postre'){
                        const spanish = selectedDishes[category].map(d=>d.spanish).join(', ');
                        const catalan = selectedDishes[category].map(d=>d.catalan).join(', ');
                        const hasExtra = selectedDishes[category].some(d=>d.extra);
                        menuHtml += `<div class="menu-item"><div class="menu-item-spanish">${spanish}</div>
                                     <div class="menu-item-catalan">${catalan}</div>
                                     ${hasExtra?'<div class="menu-item-extra">(algunos con suplemento)</div>':''}</div>`;
                    }else{
                        selectedDishes[category].forEach(dish=>{
                            menuHtml += `<div class="menu-item"><div class="menu-item-spanish">${dish.spanish}</div>
                                         <div class="menu-item-catalan">${dish.catalan}</div>
                                         ${dish.extra?`<div class="menu-item-extra">${dish.extra}</div>`:''}</div>`;
                        });
                    }
                    menuHtml += `</div>`;
                }
            });
            menuHtml += '<div class="menu-hours">HORARIO DE MENÃš 13:00 - 16:00</div>';
            document.getElementById('menuPreview').innerHTML = menuHtml;
            document.getElementById('menuPreview').style.display = 'block';
        }

        function printMenu(){
            if(document.getElementById('menuPreview').style.display==='none'){ generateMenu(); }
            const w = window.open('', '_blank'); const content = document.getElementById('menuPreview').innerHTML;
            w.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>MenÃº del dÃ­a</title>
                <style>
                    @page { margin: 20mm 22mm; size: A4; }
                    body { font-family: Arial, sans-serif; margin:0; padding:0; color:#333; line-height:1.2; }
                    .menu-header { text-align:center; border-bottom:3px solid #333; padding-bottom:15px; margin-bottom:18px; }
                    .menu-title { font-size:2.2em; font-style: italic; margin-bottom:6px; color:#333; font-weight:bold; }
                    .menu-date-price { display:flex; justify-content:space-between; font-size:1.1em; font-weight:bold; margin-top:8px; }
                    .menu-section { margin-bottom:18px; }
                    .section-title { font-size:1.2em; font-weight:bold; margin-bottom:10px; color:#333; text-transform:uppercase; letter-spacing:1px; border-bottom:1px solid #666; padding-bottom:3px; }
                    .menu-item { margin-bottom:8px; padding-bottom:4px; padding-left:8px; }
                    .menu-item-spanish { font-weight: normal; color:#333; margin-bottom:2px; font-size:12px; line-height:1.2; }
                    .menu-item-catalan { font-style: italic; color:#666; font-size:11px; line-height:1.2; margin-bottom:2px; }
                    .menu-item-extra { color:#888; font-size:11px; font-weight:500; }
                    .menu-section:last-of-type .menu-item-spanish, .menu-section:last-of-type .menu-item-catalan, .menu-section:last-of-type .menu-item-extra { font-size:10px; }
                    .menu-hours { text-align:center; margin-top:20px; padding-top:15px; border-top:2px solid #333; font-size:1.1em; font-weight:bold; letter-spacing:1px; }
                    .menu-header > div:nth-child(2){ font-size:1em; color:#666; margin-bottom:12px; font-style: italic; }
                </style></head><body>${content}</body></html>`);
            w.document.close(); w.focus(); w.print(); w.close();
        }

        async function clearSelectedDishes(){
            if(!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å·²é€‰èœå“å—ï¼Ÿ')) return;
            selectedDishes = { primer:[], segundo:[], postre:[] };
            await saveCloudData();
            renderDishesContainer(); renderSelectedDishes();
            document.getElementById('menuPreview').style.display='none';
        }

        function exportData(){
            const data = { dishes, selectedDishes, exportDate: new Date().toISOString() };
            const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
            const url = URL.createObjectURL(blob); const a = document.createElement('a');
            a.href = url; a.download = `restaurant_menu_${new Date().toISOString().split('T')[0]}.json`; a.click(); URL.revokeObjectURL(url);
        }

        async function importData(event){
            const file = event.target.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = async function(e){
                try{
                    const data = JSON.parse(e.target.result);
                    if(data.dishes && Array.isArray(data.dishes)){ dishes = data.dishes; }
                    if(data.selectedDishes){ selectedDishes = data.selectedDishes; }
                    await saveCloudData(); renderDishesContainer(); renderSelectedDishes(); alert('æ•°æ®å¯¼å…¥æˆåŠŸï¼');
                }catch(err){ alert('å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®'); }
            };
            reader.readAsText(file); event.target.value='';
        }

        async function dedupeDishes(){
            const before = dishes.length;
            const map = new Map();
            const result = [];
            for(const d of dishes){
                const key = d.category + '|' + normalize(d.spanish);
                if(!map.has(key)){ map.set(key, true); result.push(d); }
            }
            const removed = before - result.length;
            dishes = result;
            await saveCloudData();
            renderDishesContainer();
            alert(removed>0 ? `å·²æ¸…ç† ${removed} æ¡é‡å¤ã€‚` : 'æ²¡æœ‰å‘ç°é‡å¤ã€‚');
        }
    </script>
</body>
</html>
